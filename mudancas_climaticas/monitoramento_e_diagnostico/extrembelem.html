<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Eventos Extremos de Temperatura do ar</title>
  <link rel="shortcut icon" href="../../principal/imagens/logo.ico" type="image/x-icon">
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* (mantido todo o CSS anterior, omitido aqui por brevidade) */
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>Eventos Extremos de Temperatura do ar em Belém - PA</h1>
    </header>

    <div class="stats-grid">
      <!-- (cartões de estatísticas mantidos) -->
    </div>

    <div class="dashboard-grid">
      <div class="chart-card">
        <h2 class="chart-title">Mapa de Calor de Eventos Extremos de Temperatura do ar</h2>
        <div id="heatmap" class="chart-content"></div>
      </div>

      <div class="chart-card">
        <h2 class="chart-title">Número de Eventos Extremos de Temperatura do ar</h2>
        <div id="line_ano" class="chart-content"></div>
      </div>

      <div class="chart-card">
        <h2 class="chart-title">Comparação de Eventos Extremos de Temperatura do ar</h2>
        <label for="select-year">Escolha o ano para comparar com 2025:</label>
        <select id="select-year" style="margin-bottom:10px;"></select>
        <div id="line_2025" class="chart-content"></div>
      </div>
    </div>
  </div>

  <script>
    const caminhoCSV = "../../principal/base_de_dados/ERA5_dias_extremos_99p_1970_2025_belem.csv";
    const plotConfig = { displayModeBar: 'hover', displaylogo: false, responsive: true };
    const commonLayout = {
      font: { family: 'Inter, sans-serif', color: 'black', size: 12 },
      paper_bgcolor: 'rgba(0,0,0,0)',
      plot_bgcolor: 'rgba(0,0,0,0)',
      margin: { l: 60, r: 30, t: 50, b: 60 }
    };

    const eixoPreto = {
      showgrid: false,
      linecolor: 'black',
      linewidth: 2,
      mirror: false,
      ticks: 'outside',
      tickcolor: 'black',
      ticklen: 6,
      tickwidth: 2
    };

    function updateStats(data) {
      const totalDays = data.reduce((sum, d) => sum + d.dias_extremos, 0);
      const porAno = {};
      data.forEach(d => { porAno[d.year] = (porAno[d.year] || 0) + d.dias_extremos; });
      const peakYear = Object.keys(porAno).reduce((a,b) => porAno[a] > porAno[b] ? a : b);
      const peakYearValue = porAno[peakYear];
      const avgYear = Math.round(totalDays / Object.keys(porAno).length);
      const days2025 = porAno[2025] || 0;

      document.getElementById('total-days').textContent = totalDays.toLocaleString('pt-BR');
      document.getElementById('peak-year').textContent = `${peakYear} (${peakYearValue} dias)`;
      document.getElementById('avg-year').textContent = avgYear;
      document.getElementById('days-2025').textContent = days2025;
    }

    d3.csv(caminhoCSV).then(function(data) {
      data.forEach(d => { d.year = +d.year; d.month = +d.month; d.dias_extremos = +d.dias_extremos; });
      updateStats(data);

      const anos = [...new Set(data.map(d=>d.year))].sort((a,b)=>a-b);
      const nomesMeses = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];

      // Heatmap
      const z = nomesMeses.map((_, m) => anos.map(a => {
        const row = data.find(d => d.year===a && d.month===m+1);
        return row ? row.dias_extremos : 0;
      }));

      Plotly.newPlot('heatmap', [{
        z, x: anos, y: nomesMeses, type: 'heatmap',
        colorscale: [[0,'#f7fafc'],[0.2,'#fed7d7'],[0.4,'#fc8181'],[0.6,'#e53e3e'],[0.8,'#c53030'],[1,'#742a2a']],
        zmin:0, zmax:Math.max(...data.map(d=>d.dias_extremos)),
        colorbar:{title:{text:'Dias Extremos', font:{size:14,color:'black'}}, thickness:20,len:0.8},
        hovertemplate:'<b>%{y}</b><br>Ano: %{x}<br>Dias extremos: %{z}<extra></extra>'
      }],{
        ...commonLayout,
        xaxis:{...eixoPreto, title:{text:'Ano', font:{size:14,color:'black'}}, side: 'bottom'},
        yaxis:{...eixoPreto, title:{text:'Mês', font:{size:14,color:'black'}}, side: 'left', autorange:'reversed'}
      }, plotConfig);

      // Linha anual
      const porAno = {};
      data.forEach(d => { porAno[d.year] = (porAno[d.year]||0) + d.dias_extremos; });
      Plotly.newPlot('line_ano',[{
        x:Object.keys(porAno),
        y:Object.values(porAno),
        type:'scatter',
        mode:'lines+markers',
        line:{color:'red', width:3, shape:'linear'},
        marker:{size:8, color:'red', line:{color:'white', width:2}},
        fill:'tonexty', fillcolor:'rgba(255,0,0,0.1)',
        hovertemplate:'<b>Ano %{x}</b><br>Dias extremos: %{y}<extra></extra>'
      }],{
        ...commonLayout,
        xaxis:{...eixoPreto, title:{text:'Ano', font:{size:14,color:'black'}}, side:'bottom'},
        yaxis:{...eixoPreto, title:{text:'Número de Dias Extremos', font:{size:14,color:'black'}}, side:'left'},
        showlegend:false
      }, plotConfig);

      // Dropdown de seleção de ano para comparar com 2025
      const selectYear = document.getElementById('select-year');
      anos.filter(y => y !== 2025).forEach(y => {
        const option = document.createElement('option');
        option.value = y;
        option.textContent = y;
        selectYear.appendChild(option);
      });

      function plotCompare(yearSelecionado) {
        const dadosAno = data.filter(d => d.year === +yearSelecionado).sort((a,b)=>a.month-b.month);
        const dados2025 = data.filter(d => d.year === 2025).sort((a,b)=>a.month-b.month);

        const meses = nomesMeses;

        Plotly.newPlot('line_2025',[
          {
            x: meses,
            y: dadosAno.map(d => d ? d.dias_extremos : 0),
            type:'bar',
            name: yearSelecionado,
            marker:{color:'blue', line:{color:'white', width:2}},
            hovertemplate:'<b>%{x}</b><br>Dias extremos: %{y}<extra></extra>'
          },
          {
            x: meses,
            y: dados2025.map(d => d ? d.dias_extremos : 0),
            type:'bar',
            name: 2025,
            marker:{color:'red', line:{color:'white', width:2}},
            hovertemplate:'<b>%{x}</b><br>Dias extremos: %{y}<extra></extra>'
          }
        ],{
          ...commonLayout,
          barmode:'group',
          xaxis:{...eixoPreto, title:{text:'Mês', font:{size:14,color:'black'}}, side:'bottom'},
          yaxis:{...eixoPreto, title:{text:'Número de Dias Extremos', font:{size:14,color:'black'}}, side:'left'}
        }, plotConfig);
      }

      // Plot inicial comparando 2024 com 2025
      plotCompare(2024);

      selectYear.addEventListener('change', (e)=> {
        plotCompare(e.target.value);
      });

    }).catch(error=>{
      console.error("Erro ao carregar o CSV:",error);
      const errorDiv='<div class="error">⚠️ Não foi possível carregar os dados. Verifique se o arquivo CSV está no caminho correto.</div>';
      document.getElementById('heatmap').innerHTML=errorDiv;
      document.getElementById('line_ano').innerHTML=errorDiv;
      document.getElementById('line_2025').innerHTML=errorDiv;
    });
  </script>
</body>
</html>
